<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Clan Progress Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--muted:#667085;--border:#e7e9f3;
      --shadow:0 10px 30px rgba(0,0,0,.08);--r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:28px}
    .muted{color:var(--muted);font-size:13px}
    .compare{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:12px;margin:10px 0}
    .compare table{width:100%;border-collapse:collapse;font-size:14px}
    .compare th,.compare td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:14px;align-items:center}
    .badge{width:84px;height:84px;border-radius:12px;background:#eef1f6;object-fit:contain}
    .name{font-size:18px;font-weight:700;margin:0;line-height:1.2}
    .tag{font-size:12px;color:var(--muted)}
    .desc{font-size:13px;color:#444;margin-top:4px;white-space:pre-line}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{background:#fafbff;border:1px solid var(--border);border-radius:12px;padding:10px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-weight:600;margin-top:2px}
    .section{border-top:1px dashed var(--border);padding-top:10px;margin-top:6px}
    .warlines{font-family:ui-monospace,Consolas,monospace;font-size:13px}
    .pill{display:inline-block;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#f7f8fd;font-size:12px;margin-right:6px}
    .actions{margin-top:auto;display:flex;gap:10px;flex-wrap:wrap}
    .btn{text-decoration:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .btn:hover{background:#f7f8fc}
    .error{color:#b00020;font-size:13px;word-break:break-word}
    footer{margin-top:18px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Clan Progress & Performance</h1>
      <div class="muted">Live Clash of Clans data</div>
    </header>

    <div class="compare">
      <table id="compareTbl">
        <thead>
          <tr>
            <th>Clan</th>
            <th>Level</th>
            <th>CWL</th>
            <th>War Wins</th>
            <th>Win Streak</th>
            <th>War Freq</th>
            <th>Clan Points</th>
            <th>Members</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="grid" class="grid"></div>
    <footer>Last updated: <span id="stamp"></span></footer>
  </div>

  <script>
    const API_BASE = "https://clan-api.vercel.app";
    const CLANS = ["#CRUYUPOP", "#2PGOVJYLR", "#2JQP9QOU2"];
    const $ = s => document.querySelector(s);
    const fmt = n => (n?.toLocaleString?.() ?? n ?? "–");
    const safe = s => (s ?? "–");
    const normalizeTag = tag => tag.startsWith("#") ? "%23" + tag.slice(1) : tag;
    const deepLink = (tag, action="OpenClanProfile") => `https://link.clashofclans.com/en/?action=${action}&tag=${normalizeTag(tag)}`;

    async function apiGet(path, params){
      const qs = new URLSearchParams(params || {}).toString();
      const url = `${API_BASE}${path}${qs ? ("?" + qs) : ""}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`API ${r.status}`);
      return r.json();
    }

    const getClan = tag => apiGet("/api/clan", { tag });
    const getWarlog = (tag, limit=10) => apiGet("/api/warlog", { tag, limit });
    const getCurrent = tag => apiGet("/api/currentwar", { tag });
    const getRaidSeasons = (tag, limit=1) => apiGet("/api/raidseasons", { tag, limit });
    const getClanCapital = tag => apiGet("/api/clancapital", { tag });
    const getClanGames = tag => apiGet("/api/clangames", { tag });

    function makeCard(tag){
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="row">
          <div class="badge" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:#90a0b5;">…</div>
          <div>
            <div class="name">Loading…</div>
            <div class="tag">${tag}</div>
            <div class="desc" data-desc>Fetching description…</div>
            <div class="pills" data-pills></div>
          </div>
        </div>

        <div class="kv">
          <div class="stat"><div class="k">Clan Level</div><div class="v" data-k="level">–</div></div>
          <div class="stat"><div class="k">Members</div><div class="v" data-k="members">–</div></div>
          <div class="stat"><div class="k">War League</div><div class="v" data-k="cwl">–</div></div>
          <div class="stat"><div class="k">War Frequency</div><div class="v" data-k="freq">–</div></div>
          <div class="stat"><div class="k">War Wins</div><div class="v" data-k="wins">–</div></div>
          <div class="stat"><div class="k">Win Streak</div><div class="v" data-k="streak">–</div></div>
          <div class="stat"><div class="k">Clan Points</div><div class="v" data-k="points">–</div></div>
          <div class="stat"><div class="k">Capital Hall</div><div class="v" data-k="cap-hall">–</div></div>
        </div>

        <div class="section" data-section="war-performance" style="display:none;">
          <div class="k">War Performance</div>
          <div class="v" data-k="winratio">–</div>
        </div>

        <div class="section">
          <div class="k">Current War</div>
          <div class="v" data-k="current">–</div>
        </div>

        <div class="section">
          <div class="k">Clan Capital Raids</div>
          <div class="v" data-k="capital-summary">Loading…</div>
          <div class="warlines" data-k="capital-totals">–</div>
        </div>

        <div class="section">
          <div class="k">Clan Games</div>
          <div class="v" data-k="cg-status">Loading…</div>
          <div class="warlines" data-k="cg-totals">–</div>
        </div>

        <div class="actions">
          <a class="btn" data-open>Open in Clash</a>
          <a class="btn" data-join>Join Clan</a>
        </div>
        <div class="error" data-error></div>`;
      return el;
    }

    function updateCompareRow(tbody, clan){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${clan.name} <span class="muted">(${clan.tag})</span></td>
        <td>${fmt(clan.clanLevel)}</td>
        <td>${safe(clan.warLeague?.name)}</td>
        <td>${fmt(clan.warWins)}</td>
        <td>${fmt(clan.warWinStreak)}</td>
        <td>${safe(clan.warFrequency)}</td>
        <td>${fmt(clan.clanPoints)}</td>
        <td>${fmt(clan.members)}/50</td>`;
      tbody.appendChild(tr);
    }

    function renderClan(el, clan){
      const badge = clan.badgeUrls?.large || clan.badgeUrls?.medium;
      if (badge) el.querySelector(".badge").outerHTML = `<img class="badge" src="${badge}" alt="Badge">`;
      el.querySelector(".name").textContent = clan.name;
      el.querySelector(".desc").textContent = clan.description || "No description";
      el.querySelector('[data-k="level"]').textContent = fmt(clan.clanLevel);
      el.querySelector('[data-k="members"]').textContent = `${fmt(clan.members)}/50`;
      el.querySelector('[data-k="cwl"]').textContent = safe(clan.warLeague?.name);
      el.querySelector('[data-k="freq"]').textContent = safe(clan.warFrequency);
      el.querySelector('[data-k="wins"]').textContent = fmt(clan.warWins);
      el.querySelector('[data-k="streak"]').textContent = fmt(clan.warWinStreak);
      el.querySelector('[data-k="points"]').textContent = fmt(clan.clanPoints);
      const capHall = clan?.clanCapital?.capitalHallLevel;
      if (capHall) el.querySelector('[data-k="cap-hall"]').textContent = `Level ${fmt(capHall)}`;
      const pills = el.querySelector('[data-pills]');
      pills.innerHTML = (clan.labels || []).map(l=>`<span class="pill">${l.name}</span>`).join("");
      el.querySelector('[data-open]').href = deepLink(clan.tag);
      el.querySelector('[data-join]').href = deepLink(clan.tag,"JoinClan");
    }

    function renderWinRatio(el, warlog){
      const section = el.querySelector('[data-section="war-performance"]');
      if (!warlog?.items?.length) return;
      const wins = warlog.items.filter(w => w.result === "win").length;
      const total = warlog.items.length;
      const ratio = total ? (wins / total) * 100 : 0;
      if (ratio > 50) {
        section.style.display = "block";
        el.querySelector('[data-k="winratio"]').textContent = `${ratio.toFixed(1)}% wins (${wins}/${total})`;
      }
    }

    function renderCurrentWar(el,data){
      if(!data || data.state==="notInWar"){
        el.querySelector('[data-k="current"]').textContent="Not in war";
        return;
      }
      const opp=data.opponent?.name||"TBD";
      const st=data.state;
      el.querySelector('[data-k="current"]').textContent=`${st==="inWar"?"In War vs":st==="preparation"?"Prep vs":"Ended vs"} ${opp}`;
    }

    function renderCapital(el,seasons,capital){
      const s=seasons?.items?.[0];
      const sumEl=el.querySelector('[data-k="capital-summary"]');
      const totEl=el.querySelector('[data-k="capital-totals"]');
      if(!s){sumEl.textContent="No raid data";totEl.textContent="–";return;}
      const start=s.startTime?new Date(s.startTime).toLocaleDateString():"–";
      const end=s.endTime?new Date(s.endTime).toLocaleDateString():"–";
      const atk=s.totalAttacksUsed??s.totalAttacks??0;
      const dist=s.enemyDistrictsDestroyed??0;
      const loot=s.totalLooted??s.totalCapitalGoldLoot??0;
      sumEl.textContent=`Weekend ${start} – ${end}`;
      totEl.textContent=`Attacks: ${fmt(atk)} | Districts: ${fmt(dist)} | Loot: ${fmt(loot)}`;
      const hall=capital?.capitalHallLevel||capital?.clanCapital?.capitalHallLevel;
      if(hall)el.querySelector('[data-k="cap-hall"]').textContent=`Level ${fmt(hall)}`;
    }

    function renderClanGames(el,cg){
      const s=el.querySelector('[data-k="cg-status"]');
      const t=el.querySelector('[data-k="cg-totals"]');
      if(!cg){s.textContent="Not available";t.textContent="–";return;}
      const active=cg.active?"Active":"Inactive";
      const win=cg.window?` (${new Date(cg.window.start).toLocaleDateString()}–${new Date(cg.window.end).toLocaleDateString()})`:"";
      s.textContent=`${active}${win}`;
      const last=cg.last||{};
      t.textContent=`Last total: ${fmt(last.totalPoints)} | Participants: ${fmt(last.participants)} | Max/player: ${fmt(last.maxPlayerPoints)}`;
    }

    (async()=>{
      const grid=$("#grid"),tbody=$("#compareTbl tbody");
      const cards=CLANS.map(tag=>{const el=makeCard(tag);grid.appendChild(el);return{tag,el};});
      for(const {tag,el} of cards){
        try{
          const clan=await getClan(tag);
          renderClan(el,clan);
          updateCompareRow(tbody,clan);

          getWarlog(tag,10).then(wl=>renderWinRatio(el,wl)).catch(()=>{});
          getCurrent(tag).then(c=>renderCurrentWar(el,c)).catch(()=>{});
          Promise.allSettled([getRaidSeasons(tag,1),getClanCapital(tag).catch(()=>null)])
            .then(([a,b])=>renderCapital(el,a.value,b.value)).catch(()=>{});
          getClanGames(tag).then(cg=>renderClanGames(el,cg)).catch(()=>renderClanGames(el,null));
        }catch(e){
          el.querySelector('[data-error]').textContent=e.message;
        }
      }
      $("#stamp").textContent=new Date().toLocaleString();
    })();
  </script>
</body>
</html>
