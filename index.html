<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Our Clans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #fff;
      --muted: #667085;
      --border: #e7e9f3;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:#1f2328; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 18px; gap: 12px; flex-wrap: wrap; }
    h1 { font-size: 28px; margin:0; }
    .grid { display:grid; grid-template-columns: repeat( auto-fit, minmax(280px, 1fr) ); gap:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px; min-height: 220px; }
    .row { display:flex; gap:14px; align-items:center; }
    .badge { width:84px; height:84px; border-radius:12px; background:#eef1f6; object-fit:contain; }
    .name { font-size: 18px; font-weight: 700; margin:0; line-height:1.25; }
    .tag { font-size: 12px; color: var(--muted); }
    .meta { font-size: 14px; color:#222; display:flex; gap:10px; flex-wrap:wrap; }
    .muted { color: var(--muted); font-size: 13px; }
    .pills { display:flex; gap:6px; flex-wrap:wrap; }
    .pill { padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:#fafbff; }
    .actions { margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; }
    .btn { text-decoration:none; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .btn:hover { background:#f7f8fc; }
    .error { color:#b00020; font-size: 13px; word-break: break-word; }
    footer { margin-top: 22px; color:var(--muted); font-size: 12px; }
    code { background:#f0f2f7; border:1px solid #e3e6f0; padding:1px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Our Clash of Clans Families</h1>
      <div class="muted">Live stats fetched from our API (updates as Supercell updates).</div>
    </header>

    <div id="grid" class="grid"></div>

    <footer>
      Last updated: <span id="stamp"></span>
    </footer>
  </div>

  <script>
    // ====== CONFIG ======
    // Your Vercel API base (no trailing slash)
    const API_BASE = "https://clan-api.vercel.app";

    // Your three clan tags — use the raw form with '#'
    // (The backend accepts both '#TAG' and '%23TAG')
    const CLANS = [
      "#CRUYUPOP",
      "#2PGOVJYLR",
      "#2JQP9QOU2"
    ];

    // ====== UTILITIES ======
    const $ = sel => document.querySelector(sel);
    const fmt = n => (n?.toLocaleString?.() ?? n ?? "-");
    const roleCase = s => s ? s.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()) : "";

    function openUrl(tag, action="OpenClanProfile") {
      // build a link.clashofclans.com deeplink; ensure only one %23
      const raw = decodeURIComponent(tag);
      const encoded = raw.startsWith("#") ? "%23" + raw.slice(1)
                    : raw.startsWith("%23") ? raw
                    : "%23" + raw;
      return `https://link.clashofclans.com/en/?action=${action}&tag=${encoded}`;
    }

    function clanCardSkeleton(tag){
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="row">
          <div class="badge" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:#90a0b5;">…</div>
          <div>
            <div class="name">Loading…</div>
            <div class="tag">${tag}</div>
          </div>
        </div>
        <div class="meta muted">Fetching clan data…</div>
        <div class="pills"></div>
        <div class="actions" style="opacity:.5; pointer-events:none;">
          <a class="btn" href="#">Open in CoC</a>
          <a class="btn" href="#">Request to Join</a>
        </div>
      `;
      return el;
    }

    function renderClanInto(card, clan){
      const badgeUrl = clan.badgeUrls?.large || clan.badgeUrls?.medium || clan.badgeUrls?.small;
      const [img,nameEl,tagEl] = [
        card.querySelector(".badge"),
        card.querySelector(".name"),
        card.querySelector(".tag")
      ];
      if (badgeUrl) {
        img.outerHTML = `<img class="badge" alt="Clan badge" src="${badgeUrl}">`;
      } else {
        img.textContent = "No badge";
      }

      nameEl.textContent = clan.name || "Unknown";
      tagEl.textContent = clan.tag || "";

      const meta = card.querySelector(".meta");
      meta.classList.remove("muted");
      meta.innerHTML = `
        <strong>Level ${fmt(clan.clanLevel)}</strong>
        • ${fmt(clan.members)}/50 members
        ${clan.warLeague?.name ? `• CWL: <strong>${clan.warLeague.name}</strong>` : ""}
        ${Number.isFinite(clan.warWins) ? `• War wins: <strong>${fmt(clan.warWins)}</strong>` : ""}
        ${clan.location?.name ? `• ${clan.location.name}` : ""}
      `;

      const pills = card.querySelector(".pills");
      const labels = (clan.labels || []).map(l => `<span class="pill">${l.name}</span>`).join("");
      pills.innerHTML = labels;

      const actions = card.querySelector(".actions");
      actions.style.opacity = "1";
      actions.style.pointerEvents = "auto";
      actions.innerHTML = `
        <a class="btn" href="${openUrl(clan.tag, "OpenClanProfile")}">Open in Clash of Clans</a>
        <a class="btn" href="${openUrl(clan.tag, "JoinClan")}">Request to Join</a>
      `;
    }

    function renderError(card, tag, reasonText){
      const meta = card.querySelector(".meta");
      meta.classList.add("error");
      meta.innerHTML = `Couldn’t load clan <code>${tag}</code>: ${reasonText}`;
    }

    async function fetchClan(tag){
      const url = `${API_BASE}/api/clan?tag=${encodeURIComponent(tag)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`API ${res.status}: ${text}`);
      }
      return res.json();
    }

    (async () => {
      const grid = $("#grid");
      const cards = CLANS.map(tag => {
        const c = clanCardSkeleton(tag);
        grid.appendChild(c);
        return { tag, el: c };
      });

      for (const { tag, el } of cards) {
        try {
          const data = await fetchClan(tag);
          renderClanInto(el, data);
        } catch (e) {
          renderError(el, tag, e.message || "Failed to fetch");
          // Keep buttons usable even on error (deeplink still works)
          const actions = el.querySelector(".actions");
          actions.style.opacity = "1";
          actions.style.pointerEvents = "auto";
          actions.innerHTML = `
            <a class="btn" href="${openUrl(tag, "OpenClanProfile")}">Open in Clash of Clans</a>
            <a class="btn" href="${openUrl(tag, "JoinClan")}">Request to Join</a>
          `;
        }
      }

      $("#stamp").textContent = new Date().toLocaleString();
    })();
  </script>
</body>
</html>
